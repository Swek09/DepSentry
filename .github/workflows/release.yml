name: Professional Release Pipeline

permissions:
  contents: write
  id-token: write

on:
  push:
    tags:
      - 'v*'

jobs:
  # ====================================================
  # 1. WINDOWS MSI
  # ====================================================
  release-windows:
    name: Build Windows (MSI Installer)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3
      - uses: dtolnay/rust-toolchain@stable
      
      - name: Install cargo-wix
        run: cargo install cargo-wix

      - name: Build Binary
        run: cargo build --release --features ds-alias

      - name: Build MSI Installer
        run: cargo wix --no-build --nocapture
      
      - name: Prepare Artifacts
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force release-assets | Out-Null
          $msi = Get-ChildItem -Path target/wix/*.msi | Select-Object -First 1
          cp $msi.FullName release-assets/DepSentry-Installer-x64.msi
          cp target/release/depsentry.exe release-assets/depsentry-win-x64.exe

      - name: Upload Windows Assets
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            release-assets/DepSentry-Installer-x64.msi
            release-assets/depsentry-win-x64.exe

  # ====================================================
  # 2. LINUX (DEB + TAR.GZ)
  # ====================================================
  release-linux:
    name: Build Linux (Deb, Arch, Universal)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-deb
        run: cargo install cargo-deb

      - name: Build Binary
        run: cargo build --release --features ds-alias

      - name: Strip Binary
        run: |
          strip target/release/depsentry || true
          strip target/release/ds || true

      - name: Build Deb Package
        run: cargo deb --no-build

      - name: Prepare Artifacts
        run: |
          mkdir -p release-assets
          tar -czvf release-assets/DepSentry-Linux-x64.tar.gz -C target/release depsentry
          cp target/debian/*.deb release-assets/DepSentry-Linux-x64.deb
          cp target/release/depsentry release-assets/depsentry-linux-x64

      - name: Upload Linux Assets
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            release-assets/DepSentry-Linux-x64.tar.gz
            release-assets/DepSentry-Linux-x64.deb
            release-assets/depsentry-linux-x64

  # ====================================================
  # 3. NPM PUBLISH
  # ====================================================
  publish-npm:
    name: Publish npm package
    runs-on: ubuntu-latest
    needs:
      - release-windows
      - release-linux
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org
      - name: Set package version from tag
        working-directory: npm
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          npm version --no-git-tag-version --allow-same-version "$VERSION"
      - name: Publish to npm
        working-directory: npm
        run: npm publish --access public --provenance
