name: Professional Release Pipeline

permissions:
  contents: write

on:
  push:
    tags:
      - 'v*'

jobs:
  # ====================================================
  # 1. WINDOWS MSI
  # ====================================================
  release-windows:
    name: Build Windows (MSI Installer)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3
      - uses: dtolnay/rust-toolchain@stable
      
      - name: Install cargo-wix
        run: cargo install cargo-wix

      - name: Build Binary
        run: cargo build --release

      - name: Build MSI Installer
        run: cargo wix --no-build --nocapture
      
      - name: Prepare Artifacts
        shell: pwsh
        run: |
          mkdir assets
          $msi = Get-ChildItem -Path target/wix/*.msi | Select-Object -First 1
          cp $msi.FullName assets/DepSentry-Installer-x64.msi

      - name: Upload Windows Assets
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            assets/DepSentry-Installer-x64.msi

  # ====================================================
  # 2. LINUX (DEB + TAR.GZ)
  # ====================================================
  release-linux:
    name: Build Linux (Deb, Arch, Universal)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-deb
        run: cargo install cargo-deb

      - name: Build Binary
        run: cargo build --release --strip

      - name: Build Deb Package
        run: cargo deb

      - name: Prepare Artifacts
        run: |
          mkdir assets
          tar -czvf assets/DepSentry-Linux-x64.tar.gz -C target/release depsentry
          cp target/debian/*.deb assets/DepSentry-Linux-x64.deb

      - name: Upload Linux Assets
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            assets/DepSentry-Linux-x64.tar.gz
            assets/DepSentry-Linux-x64.deb